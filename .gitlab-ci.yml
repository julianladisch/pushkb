image: 
  name: ghcr.io/graalvm/graalvm-ce:ol8-java17
  # N.B. This pull policy requires the hosted gitlab runner to have if-not-present to be configured in
  # allowed pull policy in config.toml
  pull_policy: if-not-present

# Ideally we would specify tags at the root level - sadly this seems not to be supported
# This should set default tags for all stages that don't override. We use these to force a build
# onto the k-int runners where we have access to the host docker socket for building containers.
# This also prevents us consuming gitlab ci minutes as this native build is hefty.
# tags:
#   - docker
#   - docker18
#   - ki-onprem

stages:
  - test
  - build
  - deploy

default:
  services:
    # DinD (Docker-in-Docker) is required for Testcontainers and for building Docker images.
    # We use the same version across the board to avoid conflicts and simplify configuration.
    - name: docker:24.0.5-dind
      pull_policy: if-not-present
      command: ["--tls=false"]
    - name: docker:24.0.5-dind
      pull_policy: if-not-present


variables:
  DOCKER_HOST: "tcp://docker:2375"
  # Disable TLS for Docker communication.
  DOCKER_TLS_CERTDIR: ""
  # Improve Docker performance with overlayfs.
  DOCKER_DRIVER: overlay2
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  GIT_DEPTH: 0
  GRADLE_USER_HOME: "$(pwd)/.gradle"
  GIT_SUBMODULE_STRATEGY: normal
  GIT_SUBMODULE_FORCE_HTTPS: "true"

cache:
  # Cache key based on build and settings files for efficient cache invalidation.
  key:
    files:
      - build.gradle
      - settings.gradle
  # Paths to cache Gradle dependencies.
  paths:
    - .gradle/wrapper
    - .gradle/caches

# --- Test Stage ---

pushkb-test-job:
  stage: test
  tags:
    - ki-onprem
  script:
    - ./gradlew test -i

before_script:
  - GRADLE_USER_HOME="$(pwd)/.gradle"
  - export GRADLE_USER_HOME

build:
  stage: build
  only:
    - main
    - tags
  tags:
    - ki-onprem
  script:
    - ./gradlew --build-cache assemble
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: push
    paths:
      - pushKb/build
      - .gradle

dockerLogin:
  stage: build
  only:
    - main
    - tags
  tags:
    - ki-onprem
  image: 
    name: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/docker:latest
    pull_policy: if-not-present
  script:
    - docker login docker.libsdev.k-int.com --username "$NEXUS_USER" --password "$NEXUS_PASS"
    - cp ~/.docker/config.json ./config.json
  artifacts:
    paths:
      - config.json

build-native-image:
  stage: deploy
  only:
    - main
    - tags
  tags:
    - ki-onprem
  script: 
    - mkdir ~/.docker
    - pwd
    - ls
    - cp ./config.json ~/.docker/config.json
    - (./gradlew nativeCompile && ./gradlew dockerPushNative) || echo "Error building native image"
    - ./gradlew dockerPush
  artifacts:
    paths:
      - pushKb/build/native/nativeCompile/pushKb
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: pull
    paths:
      - pushKb/build
      - .gradle

